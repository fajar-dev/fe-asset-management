<script setup lang="ts">
import type { TableColumn, SelectMenuItem } from '@nuxt/ui'

import { NuxtLink } from '#components'
import type { Row } from '@tanstack/table-core'
import { useAsset } from '~/composables/useAsset'
import { useCategory } from '~/composables/useCategory'
import { useEmployee } from '~/composables/useEmployee'
import { useLocation } from '~/composables/useLocation'
import { useRole } from '~/composables/useRole'

interface EmployeeItem {
  id: string
  label: string
  avatar?: {
    src: string
    alt: string
  }
}

const UAvatar = resolveComponent('UAvatar')
const UButton = resolveComponent('UButton')
const UDropdownMenu = resolveComponent('UDropdownMenu')
const UBadge = resolveComponent('UBadge')
const ConfirmModal = resolveComponent('ConfirmModal')
const AssetAddModal = resolveComponent('AssetAddModal')
const AssetUpdateModal = resolveComponent('AssetUpdateModal')

const search = ref('')
const isDeleteModalOpen = ref(false)
const deletingAssetId = ref<string | null>(null)
const isUpdateModalOpen = ref(false)
const editingAssetId = ref<string>('')
const isFilterOpen = ref(false)
const showDatePicker = ref(false)

const { assets, apiPagination, pagination, loading, fetchAssets, deleteAsset, exportAssets } = useAsset()
const { categories, subCategories, getAllCategories, getSubCategoriesByCategory } = useCategory()
const { employees, fetchEmployees } = useEmployee()
const { locations: allLocations, getAllLocations } = useLocation()
const { isAdmin } = useRole()

const selectedCategoryId = ref<string | undefined>(undefined)
const selectedSubCategoryId = ref<string | undefined>(undefined)
const selectedStatus = ref<string | undefined>(undefined)
const selectedEmployee = ref<string | undefined>(undefined)
const selectedLocation = ref<string | undefined>(undefined)
const selectedDateRange = ref<any>(undefined)
const previewImage = ref<string | null>(null)

const tempCategoryId = ref<string | undefined>(undefined)
const tempSubCategoryId = ref<string | undefined>(undefined)
const tempStatus = ref<string | undefined>(undefined)
const tempEmployee = ref<string | undefined>(undefined)
const tempLocation = ref<string | undefined>(undefined)
const tempDateRange = ref<any>(undefined)

const statusItems: SelectMenuItem[] = [
  { label: 'Active', id: 'active' },
  { label: 'In Repair', id: 'in repair' },
  { label: 'Disposed', id: 'disposed' }
]

onMounted(async () => {
  await getAllCategories()
  await fetchEmployees()
  await getAllLocations()
  allLocations.value = allLocations.value.map(l => ({
    ...l,
    id: String(l.id)
  }))
  loadAssets()
})

watch(tempCategoryId, async (newId) => {
  if (newId) {
    await getSubCategoriesByCategory(newId)
    tempSubCategoryId.value = undefined
  } else {
    subCategories.value = []
  }
})

watch(search, () => loadAssets(1))

const categoryItems = computed<SelectMenuItem[]>(() =>
  categories.value.map(c => ({ label: c.name, id: c.id }))
)

const subCategoryItems = computed<SelectMenuItem[]>(() =>
  subCategories.value.map(sc => ({ label: sc.name, id: sc.id }))
)

const employeeItems = computed<EmployeeItem[]>(() =>
  employees.value.map(e => ({
    id: e.employeeId,
    label: e.fullName,
    avatar: {
      src: e.photoProfile,
      alt: e.fullName
    }
  }))
)

const selectedEmployeeAvatar = computed(() => {
  if (!tempEmployee.value) return undefined
  const employee = employeeItems.value.find(e => e.id === tempEmployee.value)
  return employee?.avatar
})

function loadAssets(page = pagination.value.pageIndex + 1) {
  const params: any = {
    search: search.value,
    page,
    limit: pagination.value.pageSize,
    categoryId: selectedCategoryId.value,
    subCategoryId: selectedSubCategoryId.value,
    status: selectedStatus.value,
    employeeId: selectedEmployee.value,
    locationId: selectedLocation.value
  }

  if (selectedDateRange.value?.start && selectedDateRange.value?.end) {
    params.startDate = `${selectedDateRange.value.start.year}-${String(selectedDateRange.value.start.month).padStart(2, '0')}-${String(selectedDateRange.value.start.day).padStart(2, '0')}`
    params.endDate = `${selectedDateRange.value.end.year}-${String(selectedDateRange.value.end.month).padStart(2, '0')}-${String(selectedDateRange.value.end.day).padStart(2, '0')}`
  }

  fetchAssets(params)
}

function applyFilters() {
  selectedCategoryId.value = tempCategoryId.value
  selectedSubCategoryId.value = tempSubCategoryId.value
  selectedStatus.value = tempStatus.value
  selectedEmployee.value = tempEmployee.value
  selectedLocation.value = tempLocation.value
  selectedDateRange.value = tempDateRange.value
  showDatePicker.value = false
  isFilterOpen.value = false
  loadAssets(1)
}

function resetFilters() {
  selectedCategoryId.value = undefined
  selectedSubCategoryId.value = undefined
  selectedStatus.value = undefined
  selectedEmployee.value = undefined
  selectedLocation.value = undefined
  selectedDateRange.value = undefined
  search.value = ''

  tempCategoryId.value = undefined
  tempSubCategoryId.value = undefined
  tempStatus.value = undefined
  tempEmployee.value = undefined
  tempLocation.value = undefined
  tempDateRange.value = undefined

  subCategories.value = []
  showDatePicker.value = false
  isFilterOpen.value = false
  loadAssets(1)
}

function clearDateRange() {
  tempDateRange.value = undefined
}

function toggleDatePicker(e: Event) {
  e.stopPropagation()
  showDatePicker.value = !showDatePicker.value
}

function handlePageChange(newPage: number) {
  loadAssets(newPage)
}

async function handleExport() {
  const filters: any = {
    categoryId: selectedCategoryId.value,
    subCategoryId: selectedSubCategoryId.value,
    status: selectedStatus.value,
    employeeId: selectedEmployee.value,
    locationId: selectedLocation.value
  }

  if (selectedDateRange.value?.start && selectedDateRange.value?.end) {
    filters.startDate = `${selectedDateRange.value.start.year}-${String(selectedDateRange.value.start.month).padStart(2, '0')}-${String(selectedDateRange.value.start.day).padStart(2, '0')}`
    filters.endDate = `${selectedDateRange.value.end.year}-${String(selectedDateRange.value.end.month).padStart(2, '0')}-${String(selectedDateRange.value.end.day).padStart(2, '0')}`
  }

  await exportAssets(filters)
}

const showingFrom = computed(() =>
  apiPagination.value
    ? (apiPagination.value.currentPage - 1) * apiPagination.value.itemsPerPage + 1
    : 0
)

const showingTo = computed(() =>
  apiPagination.value
    ? Math.min(apiPagination.value.currentPage * apiPagination.value.itemsPerPage, apiPagination.value.totalItems)
    : 0
)

const activeFiltersCount = computed(() => {
  let count = 0
  if (selectedCategoryId.value) count++
  if (selectedSubCategoryId.value) count++
  if (selectedStatus.value) count++
  if (selectedEmployee.value) count++
  if (selectedLocation.value) count++
  if (selectedDateRange.value?.start && selectedDateRange.value?.end) count++
  return count
})

const formattedDateRange = computed(() => {
  if (!tempDateRange.value?.start || !tempDateRange.value?.end) return 'Select date range'
  const start = new Date(
    tempDateRange.value.start.year,
    tempDateRange.value.start.month - 1,
    tempDateRange.value.start.day
  )
  const end = new Date(
    tempDateRange.value.end.year,
    tempDateRange.value.end.month - 1,
    tempDateRange.value.end.day
  )
  const formatter = new Intl.DateTimeFormat('id-ID', {
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  })
  return `${formatter.format(start)} - ${formatter.format(end)}`
})

watch(isFilterOpen, (isOpen) => {
  if (isOpen) {
    tempCategoryId.value = selectedCategoryId.value
    tempSubCategoryId.value = selectedSubCategoryId.value
    tempStatus.value = selectedStatus.value
    tempEmployee.value = selectedEmployee.value
    tempLocation.value = selectedLocation.value
    tempDateRange.value = selectedDateRange.value
    showDatePicker.value = false

    if (tempCategoryId.value) {
      getSubCategoriesByCategory(tempCategoryId.value)
    }
  }
})

async function confirmDelete() {
  if (!deletingAssetId.value) return
  await deleteAsset(deletingAssetId.value)
  deletingAssetId.value = null
  loadAssets()
  isDeleteModalOpen.value = false
}

function handleUpdated() {
  loadAssets()
}

function openImageModal(url: string) {
  previewImage.value = url
}
function closeImageModal() {
  previewImage.value = null
}

function getRowItems(row: Row<any>) {
  const category = row.original.subCategory?.category
  if (!category) return []

  const items: any[] = [{ type: 'label', label: 'Actions' }]

  if (category.hasLocation) {
    items.push({
      label: 'Location',
      icon: 'i-lucide-map-pin',
      to: `/asset/${row.original.id}/location`
    })
  }

  if (category.hasMaintenance) {
    items.push({
      label: 'Maintenance',
      icon: 'i-lucide-calendar-cog',
      to: `/asset/${row.original.id}/maintenance`
    })
  }

  if (category.hasHolder) {
    items.push({
      label: 'Holder',
      icon: 'i-lucide-users',
      to: `/asset/${row.original.id}/holder`
    })
  }

  items.push(
    {
      label: 'Detail',
      icon: 'i-lucide-notebook-pen',
      to: `/asset/${row.original.id}/detail`
    }
  )

  if (isAdmin.value) {
    items.push(
      { type: 'separator' },
      {
        label: 'Edit',
        icon: 'i-lucide-pencil',
        onSelect: () => {
          editingAssetId.value = row.original.id
          isUpdateModalOpen.value = true
        }
      },
      {
        label: 'Delete',
        icon: 'i-lucide-trash',
        color: 'error',
        onSelect: () => {
          deletingAssetId.value = row.original.id
          isDeleteModalOpen.value = true
        }
      }
    )
  }

  return items
}

const columns: TableColumn<any>[] = [
  {
    accessorKey: 'name',
    header: 'Asset',
    cell: ({ row }) =>
      h(
        NuxtLink,
        {
          to: `/asset/${row.original.id}/detail`,
          class: 'flex items-center gap-3 hover:underline'
        },
        () => [
          h('img', {
            src: row.original.imageUrl,
            alt: row.original.name,
            class: 'w-10 h-10 object-cover rounded cursor-pointer hover:scale-105 transition-transform',
            onClick: (e: Event) => {
              e.preventDefault()
              openImageModal(row.original.imageUrl)
            }
          }),
          h('div', { class: 'flex flex-col' }, [
            h('p', { class: 'font-medium text-highlighted' }, row.original.name),
            h('p', { class: 'text-xs text-muted' }, row.original.code)
          ])
        ]
      )
  },
  {
    accessorKey: 'category',
    header: 'Category',
    cell: ({ row }) => row.original.subCategory?.category.name ?? '-'
  },
  {
    accessorKey: 'subCategory',
    header: 'Sub Category',
    cell: ({ row }) => row.original.subCategory?.name ?? '-'
  },
  {
    accessorKey: 'brand',
    header: 'Brand',
    cell: ({ row }) => row.original.brand ?? '-'
  },
  {
    accessorKey: 'model',
    header: 'Model',
    cell: ({ row }) => row.original.model ?? '-'
  },
  {
    accessorKey: 'lastLocation',
    header: 'Last Location',
    cell: ({ row }) => {
      const loc = row.original.lastLocation
      if (!loc) return h('span', { class: 'text-xs text-muted' }, '-')

      return h('div', { class: 'flex flex-col' }, [
        h('span', { class: 'text-highlighted font-medium text-xs' }, loc.name),
        h('span', { class: 'text-xs' }, loc.branch?.name ?? '-')
      ])
    }
  },
  {
    accessorKey: 'employee',
    header: 'Active Holder',
    cell: ({ row }) => {
      const holder = row.original.activeHolder
      if (!holder) return h('span', '-')
      return h('div', { class: 'flex items-center gap-3' }, [
        h(UAvatar, {
          src: holder.employee.photoProfile,
          size: 'lg'
        }),
        h('div', undefined, [
          h('p', { class: 'font-medium text-highlighted text-xs' }, holder.employee.fullName),
          h('p', { class: 'text-xs' }, holder.employee.employeeId)
        ])
      ])
    }
  },
  {
    accessorKey: 'user',
    header: 'User',
    cell: ({ row }) => row.original.user ?? '-'
  },
  {
    accessorKey: 'price',
    header: 'Price',
    cell: ({ row }) => {
      const price = row.original.price
      if (!price) return h('span', { class: 'text-xs text-muted' }, '-')
      const formatted = new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(Number(price))
      return h('span', { class: 'text-xs font-medium' }, formatted)
    }
  },
  {
    accessorKey: 'purchaseDate',
    header: 'Purchase Date',
    cell: ({ row }) => {
      const date = row.original.purchaseDate
      const age = row.original.age
      if (!date) return h('span', { class: 'text-xs text-muted' }, '-')
      const formatted = new Date(date).toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      })
      return h('div', { class: 'flex flex-col' }, [
        h('span', { class: 'text-xs text-highlighted' }, formatted),
        h('span', { class: 'text-xs' }, age ?? '-')
      ])
    }
  },
  {
    accessorKey: 'status',
    header: 'Status',
    filterFn: 'equals',
    cell: ({ row }) => {
      type AssetStatus = 'active' | 'disposed' | 'in repair'
      const status = row.original.status as AssetStatus
      const colorMap: Record<AssetStatus, 'success' | 'error' | 'warning'> = {
        'active': 'success',
        'disposed': 'error',
        'in repair': 'warning'
      }
      const displayStatus = status
        .split(' ')
        .map(s => s.charAt(0).toUpperCase() + s.slice(1))
        .join(' ')
      return h(
        UBadge,
        { class: 'capitalize', variant: 'subtle', color: colorMap[status] },
        () => displayStatus
      )
    }
  },
  {
    id: 'actions',
    cell: ({ row }) =>
      h(
        'div',
        { class: 'text-right' },
        h(
          UDropdownMenu,
          { content: { align: 'end' }, items: getRowItems(row) },
          () =>
            h(UButton, {
              icon: 'i-lucide-ellipsis-vertical',
              color: 'neutral',
              variant: 'ghost',
              class: 'ml-auto'
            })
        )
      )
  }
]
</script>

<template>
  <UDashboardPanel id="assets">
    <template #header>
      <UDashboardNavbar title="Assets">
        <template #leading>
          <UDashboardSidebarCollapse />
        </template>
        <template #right>
          <RoleWrapper role="admin">
            <AssetAddModal @created="loadAssets()" />
          </RoleWrapper>
          <AssetScanModal />
        </template>
      </UDashboardNavbar>
    </template>

    <template #body>
      <RoleWrapper role="admin">
        <ConfirmModal
          v-model:open="isDeleteModalOpen"
          title="Delete Asset"
          description="Are you sure? This action cannot be undone."
          confirm-label="Delete"
          :on-confirm="confirmDelete"
        />
        <AssetUpdateModal
          v-if="editingAssetId"
          v-model="isUpdateModalOpen"
          :asset-id="editingAssetId"
          @updated="handleUpdated"
        />
      </RoleWrapper>

      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
        <UInput
          v-model="search"
          class="max-w-lg"
          icon="i-lucide-search"
          placeholder="Search assets..."
        />

        <div class="flex gap-2 items-center">
          <UButton
            color="primary"
            variant="subtle"
            icon="i-lucide-file-down"
            :loading="loading"
            @click="handleExport"
          >
            Export
          </UButton>
          <UPopover v-model:open="isFilterOpen" :popper="{ placement: 'bottom-end' }">
            <UButton
              color="neutral"
              variant="subtle"
              icon="i-lucide-filter"
              trailing-icon="i-lucide-chevron-down"
            >
              Filters
              <UBadge
                v-if="activeFiltersCount > 0"
                color="primary"
                variant="solid"
                size="sm"
                class="ml-2"
              >
                {{ activeFiltersCount }}
              </UBadge>
            </UButton>

            <template #content>
              <div class="p-4 w-80 space-y-4 max-h-[80vh] overflow-y-auto" @click.stop>
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-sm">
                    Filter Assets
                  </h3>
                  <UButton
                    v-if="activeFiltersCount > 0"
                    color="error"
                    variant="link"
                    size="xs"
                    @click="resetFilters"
                  >
                    Reset All
                  </UButton>
                </div>

                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium mb-1.5">Category</label>
                    <USelectMenu
                      v-model="tempCategoryId"
                      class="w-full"
                      value-key="id"
                      :items="categoryItems"
                      placeholder="Select category"
                      searchable
                      searchable-placeholder="Search category..."
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1.5">Sub Category</label>
                    <USelectMenu
                      v-model="tempSubCategoryId"
                      class="w-full"
                      value-key="id"
                      :items="subCategoryItems"
                      placeholder="Select sub category"
                      searchable
                      searchable-placeholder="Search sub category..."
                      :disabled="!tempCategoryId"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1.5">Status</label>
                    <USelectMenu
                      v-model="tempStatus"
                      class="w-full"
                      value-key="id"
                      :items="statusItems"
                      placeholder="Select status"
                      searchable
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1.5">Last Location</label>
                    <USelectMenu
                      v-model="tempLocation"
                      class="w-full"
                      value-key="id"
                      :items="allLocations.map(l => ({
                        label: `${l.name} - ${l.branch?.name ?? '-'}`,
                        id: String(l.id)
                      }))"
                      placeholder="Select last location"
                      searchable
                      searchable-placeholder="Search location..."
                      clearable
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1.5">Active Holder</label>
                    <USelectMenu
                      v-model="tempEmployee"
                      class="w-full"
                      value-key="id"
                      :avatar="selectedEmployeeAvatar"
                      :items="employeeItems"
                      placeholder="Select holder"
                      searchable
                      searchable-placeholder="Search employee..."
                    />
                  </div>

                  <div>
                    <div class="flex items-center justify-between mb-1.5">
                      <label class="block text-sm font-medium">Purchase Date</label>
                      <UButton
                        v-if="tempDateRange"
                        color="error"
                        variant="link"
                        size="xs"
                        @click.stop="clearDateRange"
                      >
                        Clear
                      </UButton>
                    </div>

                    <UButton
                      color="neutral"
                      variant="outline"
                      block
                      icon="i-lucide-calendar"
                      :trailing-icon="showDatePicker ? 'i-lucide-chevron-up' : 'i-lucide-chevron-down'"
                      class="justify-start"
                      @click="toggleDatePicker"
                    >
                      <span class="truncate text-sm">{{ formattedDateRange }}</span>
                    </UButton>

                    <div v-if="showDatePicker" class="mt-2 p-3 border border-default rounded-lg bg-elevated" @click.stop>
                      <UCalendar
                        v-model="tempDateRange"
                        range
                      />
                    </div>
                  </div>
                </div>

                <div class="pt-3">
                  <UButton
                    color="primary"
                    variant="soft"
                    block
                    @click="applyFilters"
                  >
                    Apply Filters
                  </UButton>
                </div>
              </div>
            </template>
          </UPopover>
        </div>
      </div>

      <UTable
        v-model:pagination="pagination"
        :data="assets"
        :columns="columns"
        :loading="loading"
        :ui="{ base: 'table-fixed border-separate border-spacing-0', thead: '[&>tr]:bg-elevated/50 [&>tr]:after:content-none', tbody: '[&>tr]:last:[&>td]:border-b-0', th: 'py-2 first:rounded-l-lg last:rounded-r-lg border-y border-default first:border-l last:border-r', td: 'border-b border-default' }"
      />

      <div class="flex flex-col md:flex-row items-center justify-center md:justify-between gap-3 border-t border-default pt-4 mt-auto">
        <UPagination
          v-if="apiPagination"
          :default-page="pagination.pageIndex + 1"
          :items-per-page="pagination.pageSize"
          :total="apiPagination.totalItems"
          @update:page="handlePageChange"
        />
        <div v-if="apiPagination" class="text-sm text-muted mb-2">
          Showing {{ showingFrom }} to {{ showingTo }} of {{ apiPagination.totalItems }} results
        </div>
      </div>
    </template>
  </UDashboardPanel>

  <div
    v-if="previewImage"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/70"
    @click.self="closeImageModal"
  >
    <img
      :src="previewImage"
      alt="Preview"
      class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg"
    >
  </div>
</template>
